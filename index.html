<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园卡一体化服务平台</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        :root {
            --primary-color: #007bff; 
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d; 
            --light-bg: #f8f9fa; 
            --white-bg: #ffffff;
            --border-color: #dee2e6;
            --text-color: #212529;
            --text-light: #495057;
            --success-color: #28a745;
            --success-hover: #1e7e34;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8; /* Teal/Cyan like color for info */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        
            /* Tab specific accent colors for H2 titles */
            --accent-report-lost: #fd7e14; /* Orange */
            --accent-my-lost: #17a2b8; /* Info Blue */
            --accent-seeking: #e89f17; /* Darker Yellow/Gold */
            --accent-report-found: #28a745; /* Green */
            --accent-browse-found: #007bff; /* Primary Blue */
            --accent-leaderboard: #6f42c1; /* Purple */
            --accent-risk-areas: #dc3545; /* Red */
            --accent-store: #20c997; /* Teal */
        }

        body {
            font-family: var(--font-family);
            background-color: #f4f6f9; /* Softer page background */
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        .app-container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: var(--white-bg);
            min-height: 95vh;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); /* Softer shadow */
            border-radius: 12px; /* More rounded corners */
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #0d6efd, #0a58ca); /* Slightly different blue gradient */
            color: white;
            padding: 20px 25px;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 2.1em;
            font-weight: 600;
        }
        .tabs {
            display: flex;
            background-color: var(--white-bg); 
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
            box-shadow: 0 3px 6px rgba(0,0,0,0.04);
        }
        .tab-button {
            padding: 16px 22px; 
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            color: var(--text-light);
            border-bottom: 4px solid transparent;
            transition: color 0.25s ease, border-color 0.25s ease, background-color 0.25s ease;
            font-weight: 500;
            flex-shrink: 0; /* Prevent shrinking on small screens */
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 700; /* Bolder active tab */
        }
        .tab-button:hover {
            color: var(--primary-color);
            background-color: #f1f3f5;
        }
        .tab-content {
            display: none;
            padding: 30px; /* Increased padding */
            animation: fadeIn 0.4s ease-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background-color: var(--white-bg);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef; /* Softer border for sections */
        }
        h2 { /* General h2 style for tab content */
            border-bottom: 1px solid #e0e0e0; /* Thinner border */
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.6em;
            font-weight: 600;
        }
        
        /* Tab specific H2 colors */
        #tab-report-lost h2 { color: var(--accent-report-lost); border-left: 4px solid var(--accent-report-lost); padding-left: 10px;}
        #tab-my-lost h2 { color: var(--accent-my-lost); border-left: 4px solid var(--accent-my-lost); padding-left: 10px;}
        #tab-seeking-cards h2 { color: var(--accent-seeking); border-left: 4px solid var(--accent-seeking); padding-left: 10px;}
        #tab-report-found h2 { color: var(--accent-report-found); border-left: 4px solid var(--accent-report-found); padding-left: 10px;}
        #tab-browse-found h2 { color: var(--accent-browse-found); border-left: 4px solid var(--accent-browse-found); padding-left: 10px;}
        #tab-points-leaderboard h2 { color: var(--accent-leaderboard); border-left: 4px solid var(--accent-leaderboard); padding-left: 10px;}
        #tab-risk-areas h2 { color: var(--accent-risk-areas); border-left: 4px solid var(--accent-risk-areas); padding-left: 10px;}
        #tab-redemption-store h2 { color: var(--accent-store); border-left: 4px solid var(--accent-store); padding-left: 10px;}


        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #343a40; }
        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="file"],
        .form-group input[type="number"],
        .form-group input[type="datetime-local"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
            outline: none;
        }
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.05em;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        }
        .btn:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(0,0,0,0.07); }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: var(--success-hover); }
        .btn-warning { background-color: var(--warning-color); color: var(--text-color); }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-sm { padding: 8px 16px; font-size: 0.9em; }
        
        .item-list { display: flex; flex-direction: column; gap: 18px; }
        .item-card {
            background-color: var(--white-bg);
            border: 1px solid #e0e0e0; /* Softer border */
            border-radius: 8px; /* More rounded */
            padding: 20px;
            transition: box-shadow 0.2s ease, transform 0.15s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.06);
        }
        .item-card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); transform: translateY(-3px); }
        .item-card h3 { margin-top: 0; font-size: 1.2em; color: #333; margin-bottom: 10px; font-weight: 600; }
        .item-card p { margin: 6px 0; font-size: 0.95em; color: var(--text-light); }
        .item-card p strong { color: var(--text-color); }
        
        .bluetooth-sim { margin-top: 15px; padding: 15px; border: 1px dashed #adb5bd; border-radius: 6px; background-color: var(--light-bg); }
        .signal-strength {
            width: 100%; background-color: #e9ecef; border-radius: 4px; margin-top: 10px;
            height: 25px; overflow: hidden; border: 1px solid #ced4da;
        }
        .signal-bar {
            height: 100%; background-color: var(--success-color); width: 0%;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
            text-align: center; color: white; font-size: 0.85em; line-height: 25px; font-weight: bold;
        }

        #map { height: 350px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--border-color); }
        
        .leaderboard ol { list-style-type: none; padding-left: 0; }
        .leaderboard li {
            background-color: #f8f9fa;
            padding: 12px 18px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .leaderboard li:hover { background-color: #e9ecef; transform: translateX(2px); }
        .leaderboard li .rank { font-weight: bold; margin-right: 15px; color: var(--accent-leaderboard); font-size: 1.1em; }
        .leaderboard li .name { flex-grow: 1; font-weight: 500; }
        .leaderboard li .points, .leaderboard li .count { font-weight: bold; color: var(--primary-color); }

        /* Histogram Styles */
        .histogram-section { padding-top: 10px;} /* Add some space for h2 */
        .histogram-section h3 {
            font-size: 1.2em;
            color: var(--accent-risk-areas);
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }
        .histogram-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 280px; /* Ensure container has height */
            padding: 20px 10px 0 10px; /* Padding around bars */
            background-color: var(--white-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            margin: 0 5px; /* Spacing between bars */
            position: relative; /* For absolute positioning of value */
            height: 100%; /* Allow bar to use percentage height */
        }
        .bar {
            width: 75%; 
            max-width: 45px; 
            background-color: var(--primary-color); /* Default color, will be overridden */
            border-radius: 5px 5px 0 0;
            transition: height 0.7s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.3s;
            position: absolute; /* Position from bottom */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        .bar:hover {
            opacity: 0.8;
        }
        .bar-value {
            position: absolute;
            top: -25px; /* Position above the bar */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            color: var(--font-dark);
            font-weight: bold;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .bar-label {
            position: absolute;
            bottom: -25px; /* Position below the bar wrapper */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            font-size: 0.85em;
            color: var(--text-light);
            text-align: center;
            font-weight: 500;
        }

        /* Redemption Store Styles */
        .user-info-store {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary-color); /* Placeholder color */
            overflow: hidden; /* If using img */
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-info-store p { margin: 5px 0; font-size: 1.05em; }
        .user-info-store strong { color: var(--accent-store); font-weight: 600; }

        .store-item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }
        .store-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background-color: var(--white-bg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .store-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.1);
        }
        .store-item-image {
            width: 120px;
            height: 120px;
            background-color: #e9ecef;
            margin: 0 auto 15px;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--secondary-color);
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        .store-item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }
        .store-item h4 { margin: 10px 0 8px; font-size: 1.15em; color: var(--text-color); font-weight: 600;}
        .store-item .points-cost { color: var(--accent-store); font-weight: bold; margin-bottom: 12px; font-size: 1.1em;}
        
        footer {
            text-align: center;
            padding: 25px;
            color: #6c757d;
            font-size: 0.9em;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-bg);
        }
         /* Alert/Message Styling */
        .alert-message {
            padding: 12px 18px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 1em;
            text-align: center;
            animation: slideDownFadeIn 0.5s ease-out;
        }
        @keyframes slideDownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-success {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }
        .alert-info {
            background-color: #cff4fc;
            color: #055160;
            border: 1px solid #b6effb;
        }
         .alert-danger {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }
        #global-message-area {
            padding: 0 20px;
            position: sticky; /* Make it sticky */
            top: 0; /* Stick to the top of its container */
            z-index: 1000; /* Ensure it's above other tab content */
            background-color: var(--white-bg); /* Match app container or make it slightly transparent */
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>校园卡一体化服务平台</h1>
        </header>

        <nav class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'tab-report-lost')">挂失发布</button>
            <button class="tab-button" onclick="openTab(event, 'tab-my-lost')">我的挂失与感应</button>
            <button class="tab-button" onclick="openTab(event, 'tab-seeking-cards')">寻卡悬赏</button>
            <button class="tab-button" onclick="openTab(event, 'tab-report-found')">上报拾卡</button>
            <button class="tab-button" onclick="openTab(event, 'tab-browse-found')">已拾取信息</button>
            <button class="tab-button" onclick="openTab(event, 'tab-points-leaderboard')">拾卡英雄榜</button>
            <button class="tab-button" onclick="openTab(event, 'tab-risk-areas')">易丢卡区域</button>
            <button class="tab-button" onclick="openTab(event, 'tab-redemption-store')">兑换商店</button>
        </nav>
        
        <div id="global-message-area"></div>


        <div id="tab-report-lost" class="tab-content active">
            <section class="section">
                <h2>我要挂失校园卡</h2>
                <form id="lost-card-form">
                    <div class="form-group">
                        <label for="lost-student-id">学号</label>
                        <input type="text" id="lost-student-id" value="20240001" required>
                    </div>
                    <div class="form-group">
                        <label for="lost-student-name">姓名</label>
                        <input type="text" id="lost-student-name" value="王小明" required>
                    </div>
                    <div class="form-group">
                        <label for="lost-contact-info">联系方式（电话/微信）</label>
                        <input type="tel" id="lost-contact-info" value="13800138000" required>
                    </div>
                    <div class="form-group">
                        <label for="lost-last-seen">最后可能丢失地点/时间</label>
                        <textarea id="lost-last-seen" placeholder="例如：三食堂二楼靠窗位置，今天午饭时间">三食堂二楼靠窗，今天午饭时间</textarea>
                    </div>
                    <div class="form-group">
                        <label for="lost-reward-points">悬赏积分 (可选)</label>
                        <input type="number" id="lost-reward-points" value="20" min="0">
                    </div>
                    <button type="submit" class="btn">确认挂失并发布</button>
                </form>
            </section>
        </div>

        <div id="tab-my-lost" class="tab-content">
            <section class="section">
                <h2>我的挂失记录与感应</h2>
                <div class="item-list" id="my-lost-reports-list">
                    <p id="no-my-lost-reports">您还没有挂失任何校园卡。</p>
                </div>
            </section>
        </div>

        <div id="tab-seeking-cards" class="tab-content">
            <section class="section">
                <h2>寻卡悬赏 (大家都在找)</h2>
                <div class="item-list" id="seeking-cards-list">
                     <div class="item-card" id="seeking-demoCard0"><h3>寻找学号 2024****111 (示例用户 同学)</h3><p><strong>丢失地点：</strong>教学楼C座门口</p><p><strong>丢失时间：</strong>不久前</p><p><strong>悬赏积分：</strong>10 分</p><p><strong>联系方式：</strong>13912345678</p><button class="btn btn-success btn-sm" onclick="reportFoundForThis('2024****111', '示例用户', '教学楼C座门口')">我找到了！去上报</button></div>
                     <div class="item-card"><h3>寻找学号尾号 ****5678 (王同学)</h3><p><strong>丢失地点：</strong>校巴站台附近</p><p><strong>丢失时间：</strong>昨天下午</p><p><strong>悬赏积分：</strong>50 分</p><p><strong>联系方式：</strong>13788889999</p><button class="btn btn-success btn-sm" onclick="reportFoundForThis('****5678', '王同学', '校巴站台附近')">我找到了！去上报</button></div>
                </div>
            </section>
        </div>

        <div id="tab-report-found" class="tab-content">
             <section class="section">
                <h2>我拾到了校园卡 (感谢您的热心！)</h2>
                <form id="found-card-form">
                    <div class="form-group">
                        <label for="found-card-id">卡上学号 (若可见)</label>
                        <input type="text" id="found-card-id" placeholder="请填写完整的学号">
                    </div>
                    <div class="form-group">
                        <label for="found-card-name">卡上姓名 (若可见)</label>
                        <input type="text" id="found-card-name" placeholder="请填写卡上的姓名">
                    </div>
                    <div class="form-group">
                        <label for="found-location">拾取地点</label>
                        <input type="text" id="found-location" placeholder="例如：图书馆三楼B区阅览室" required>
                    </div>
                     <div class="form-group">
                        <label for="found-time">拾取时间</label>
                        <input type="datetime-local" id="found-time" name="found-time" value=""> </div>
                    <div class="form-group">
                        <label for="finder-contact">您的联系方式 (选填)</label>
                        <input type="text" id="finder-contact" placeholder="电话或短号，方便失主感谢">
                    </div>
                    <div class="form-group">
                        <label for="card-photo">卡片照片 (可选)</label>
                        <input type="file" id="card-photo" accept="image/*">
                    </div>
                     <div class="form-group">
                        <p style="color: var(--success-color); font-weight: bold;">成功提交有效拾卡信息可获得校园积分奖励！</p>
                    </div>
                    <button type="submit" class="btn btn-success">提交拾取信息</button>
                </form>
            </section>
        </div>

        <div id="tab-browse-found" class="tab-content">
            <section class="section">
                <h2>已拾取校园卡列表</h2>
                <input type="text" id="browse-search-bar" placeholder="按姓名或学号尾号搜索..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 20px; box-sizing: border-box;">
                <div class="item-list" id="found-cards-display-list">
                    <div class="item-card">
                        <h3>张伟 同学 (学号: 2023****1234)</h3>
                        <p><strong>拾取地点:</strong> 一食堂门口</p>
                        <p><strong>拾取时间:</strong> 2025年5月31日 12:30</p>
                        <p><strong>上报人:</strong> 热心同学 (联系方式已隐藏)</p>
                        <button class="btn btn-sm">联系认领</button>
                    </div>
                </div>
                <div id="map" style="margin-top: 20px;"></div>
            </section>
        </div>

        <div id="tab-points-leaderboard" class="tab-content">
            <section class="section">
                <h2>拾卡英雄榜</h2>
                <div class="leaderboard">
                    <ol>
                        <li><span class="rank">1.</span> <span class="name">雷锋侠</span> <span class="points">150 积分</span></li>
                        <li><span class="rank">2.</span> <span class="name">寻卡小能手</span> <span class="points">125 积分</span></li>
                        <li><span class="rank">3.</span> <span class="name">匿名奉献者</span> <span class="points">90 积分</span></li>
                        <li><span class="rank">4.</span> <span class="name">校园守护者</span> <span class="points">75 积分</span></li>
                        <li><span class="rank">5.</span> <span class="name">热心学长</span> <span class="points">60 积分</span></li>
                    </ol>
                </div>
            </section>
        </div>

        <div id="tab-risk-areas" class="tab-content">
            <section class="section histogram-section">
                <h2>校园卡易丢失区域分析 (本月数据)</h2>
                <div class="histogram-container" id="risk-histogram">
                    </div>
            </section>
        </div>
        
        <div id="tab-redemption-store" class="tab-content">
            <section class="section">
                <h2>兑换商店</h2>
                <div class="user-info-store">
                    <div class="user-avatar">
                        <img src="images/avatar.jpg" alt="用户头像" onerror="this.style.display='none'; this.parentElement.innerHTML='头像';">
                    </div>
                    <div>
                        <p>您好，<span id="store-user-name">王小明</span>同学！</p>
                        <p>当前可用积分: <strong id="user-points">125 积分</strong></p>
                        <p>默认寝室地址: <strong id="user-dorm-address">梅园2栋 301室</strong></p>
                    </div>
                </div>
                <h3>热门兑换</h3>
                <div class="store-item-list">
                    <div class="store-item">
                        <div class="store-item-image">
                            <img src="images/notebook.jpg" alt="笔记本" onerror="this.parentElement.innerHTML='笔记本';">
                        </div>
                        <h4>优质笔记本</h4>
                        <p class="points-cost">50 积分</p>
                        <button class="btn btn-sm btn-success" onclick="redeemItem('优质笔记本', 50)">立即兑换</button>
                    </div>
                    <div class="store-item">
                        <div class="store-item-image">
                            <img src="images/detergent.jpg" alt="洗衣液" onerror="this.parentElement.innerHTML='洗衣液';">
                        </div>
                        <h4>品牌洗衣液 500ml</h4>
                        <p class="points-cost">80 积分</p>
                        <button class="btn btn-sm btn-success" onclick="redeemItem('品牌洗衣液', 80)">立即兑换</button>
                    </div>
                    <div class="store-item">
                        <div class="store-item-image">
                             <img src="images/snacks.jpg" alt="零食包" onerror="this.parentElement.innerHTML='零食包';">
                        </div>
                        <h4>零食大礼包</h4>
                        <p class="points-cost">120 积分</p>
                        <button class="btn btn-sm btn-success" onclick="redeemItem('零食大礼包', 120)">立即兑换</button>
                    </div>
                    <div class="store-item">
                        <div class="store-item-image">
                            <img src="images/bag.jpg" alt="帆布袋" onerror="this.parentElement.innerHTML='帆布袋';">
                        </div>
                        <h4>校园文创帆布袋</h4>
                        <p class="points-cost">100 积分</p>
                        <button class="btn btn-sm btn-success" onclick="redeemItem('校园文创帆布袋', 100)">立即兑换</button>
                    </div>
                </div>
            </section>
        </div>


        <footer>
            <p>&copy; 2025 智能校园卡服务平台. 北京邮电大学.</p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        let map;
        let userLostCardCount = 0; 
        let userPoints = 125; // Initial user points for demo
        const globalMessageArea = document.getElementById('global-message-area');


        function showGlobalMessage(message, type = 'info') {
            globalMessageArea.innerHTML = `<div class="alert-message alert-${type}">${message}</div>`;
            setTimeout(() => {
                const alertMessage = globalMessageArea.querySelector('.alert-message');
                if (alertMessage) {
                    alertMessage.style.opacity = '0';
                    setTimeout(() => { globalMessageArea.innerHTML = ''; }, 300); // Remove after fade
                }
            }, 3700); // Display for 3.7s, then start fade out
        }

        function openTab(event, tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.style.display = 'none');
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).style.display = 'block';
            // If event is null (programmatic call), find button by tabName
            const currentButton = event ? event.currentTarget : document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
            if (currentButton) {
                currentButton.classList.add('active');
            }


            if (tabName === 'tab-browse-found' && (!map || !map.getContainer())) {
                initMap();
            }
            if (tabName === 'tab-risk-areas') {
                renderHistogram();
            }
            if (tabName === 'tab-my-lost') {
                // Check if only the placeholder exists before populating
                const listElement = document.getElementById('my-lost-reports-list');
                if (listElement.children.length === 0 || (listElement.children.length === 1 && listElement.children[0].id === 'no-my-lost-reports')) {
                     populateMyLostCardsDemo();
                }
            }
            if (tabName === 'tab-redemption-store') {
                document.getElementById('user-points').textContent = `${userPoints} 积分`;
            }
        }

        function initMap() {
            if (map) { 
                map.remove();
            }
            const buptShaheCoords = [40.1585, 116.2880]; 
            map = L.map('map').setView(buptShaheCoords, 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            L.marker(buptShaheCoords).addTo(map).bindPopup("北京邮电大学沙河校区").openPopup();
            updateMapMarkers();
        }
        
        function updateMapMarkers() {
            if (!map) return;
            map.eachLayer(function (layer) {
                if (layer instanceof L.Marker && layer.getLatLng().lat.toFixed(4) !== '40.1585') { 
                    map.removeLayer(layer);
                }
            });

            const foundCardsList = document.getElementById('found-cards-display-list');
            const cards = foundCardsList.querySelectorAll('.item-card');
            const locations = [ 
                { name: "一食堂", coords: [40.1590, 116.2875] },
                { name: "校巴站台", coords: [40.1580, 116.2895] },
                { name: "图书馆", coords: [40.1575, 116.2860] },
                { name: "操场", coords: [40.1570, 116.2905] },
                { name: "教学楼B座", coords: [40.1595, 116.2850] },
                { name: "学生活动中心", coords: [40.1588, 116.2899] },
                { name: "科研楼", coords: [40.1600, 116.2870] }
            ];
            
            cards.forEach((card, index) => {
                const cardNameElement = card.querySelector('h3');
                const cardLocationP = Array.from(card.querySelectorAll('p')).find(p => p.textContent.includes('拾取地点:'));
                if (!cardNameElement || !cardLocationP) return;

                const cardName = cardNameElement.textContent.split('(')[0].trim();
                const cardLocationText = cardLocationP.textContent.replace('拾取地点:', '').trim();
                
                const locData = locations.find(l => cardLocationText.toLowerCase().includes(l.name.toLowerCase())) || locations[index % locations.length]; 
                
                if (locData && locData.coords) {
                     L.marker(locData.coords).addTo(map)
                        .bindPopup(`<b>${cardName}</b><br>在 ${cardLocationText} 拾取。`);
                }
            });
        }

        document.getElementById('lost-card-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const studentId = document.getElementById('lost-student-id').value;
            const studentName = document.getElementById('lost-student-name').value;
            const contactInfo = document.getElementById('lost-contact-info').value;
            const lastSeen = document.getElementById('lost-last-seen').value || "未详细说明";
            const rewardPoints = document.getElementById('lost-reward-points').value || "0";

            if (!studentId || !studentName) {
                showGlobalMessage("学号和姓名不能为空！", "danger");
                return;
            }
            userLostCardCount++;
            const cardUniqueId = `userCard${Date.now()}`; // More unique ID

            const myLostList = document.getElementById('my-lost-reports-list');
            const noMyReportsMsg = document.getElementById('no-my-lost-reports');
            if(noMyReportsMsg) noMyReportsMsg.style.display = 'none';

            const myLostItemHTML = `
                <div class="item-card" id="my-lost-${cardUniqueId}">
                    <h3>我的卡：${studentId} (${studentName})</h3>
                    <p><strong>最后已知地点:</strong> ${lastSeen}</p>
                    <p><strong>悬赏积分:</strong> ${rewardPoints} 分</p>
                    <p>状态: <span class="my-status-indicator" id="my-status-${cardUniqueId}" style="color:var(--warning-color); font-weight:bold;">搜寻中...</span></p>
                    <div class="bluetooth-sim">
                        <p><strong>远距离蓝牙示意:</strong> 大致在 <span id="my-far-location-${cardUniqueId}">未知区域</span></p>
                        <button class="btn btn-sm btn-warning" onclick="simulateNearSignalInteractive('${cardUniqueId}')">开始近距离感应</button>
                        <div id="my-near-signal-${cardUniqueId}" style="display: none; margin-top: 10px;">
                            <p><strong>近距离信号:</strong> <span id="my-near-signal-text-${cardUniqueId}">正在搜索...</span></p>
                            <div class="signal-strength"><div id="my-signal-bar-${cardUniqueId}" class="signal-bar"></div></div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" style="margin-top: 10px;" onclick="markMyCardAsFound('${cardUniqueId}', this)">我已找回此卡</button>
                </div>`;
            myLostList.insertAdjacentHTML('afterbegin', myLostItemHTML);

            const seekingList = document.getElementById('seeking-cards-list');
            const seekingItemHTML = `
                <div class="item-card" id="seeking-${cardUniqueId}">
                    <h3>寻找学号 ${studentId} (${studentName} 同学)</h3>
                    <p><strong>丢失地点：</strong> ${lastSeen}</p>
                    <p><strong>悬赏积分：</strong> ${rewardPoints} 分</p>
                    <p><strong>联系方式：</strong> ${contactInfo}</p>
                    <button class="btn btn-success btn-sm" onclick="reportFoundForThis('${studentId}', '${studentName}', '${lastSeen.replace(/'/g, "\\'")}')">我找到了！去上报</button>
                </div>`;
            seekingList.insertAdjacentHTML('afterbegin', seekingItemHTML);

            showGlobalMessage('挂失信息已提交，并已发布到“寻卡悬赏”和“我的挂失记录”！', 'success');
            this.reset();
            
            const seekingTabButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.getAttribute('onclick').includes('tab-seeking-cards'));
            if(seekingTabButton) openTab(null, 'tab-seeking-cards'); // Programmatic tab switch
        });

        document.getElementById('found-card-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const cardId = document.getElementById('found-card-id').value || "未知学号";
            const cardName = document.getElementById('found-card-name').value || "未知姓名";
            const location = document.getElementById('found-location').value;
            const foundTimeInput = document.getElementById('found-time').value;
            const finderContact = document.getElementById('finder-contact').value || "热心同学";
            
            if (!location) {
                showGlobalMessage("拾取地点不能为空！", "danger");
                return;
            }

            const foundTime = foundTimeInput ? new Date(foundTimeInput).toLocaleString('zh-CN', { hour12: false }) : new Date().toLocaleString('zh-CN', { hour12: false });

            const foundCardsList = document.getElementById('found-cards-display-list');
            const newItemHTML = `
                <div class="item-card">
                    <h3>${cardName} 同学 (学号: ${cardId})</h3>
                    <p><strong>拾取地点:</strong> ${location}</p>
                    <p><strong>拾取时间:</strong> ${foundTime}</p>
                    <p><strong>上报人:</strong> ${finderContact}</p>
                    <button class="btn btn-sm">联系认领</button>
                </div>`;
            foundCardsList.insertAdjacentHTML('afterbegin', newItemHTML);
            
            const seekingCards = document.querySelectorAll('#seeking-cards-list .item-card');
            seekingCards.forEach(seekingCard => {
                const seekingH3 = seekingCard.querySelector('h3');
                if (seekingH3) {
                    const seekingText = seekingH3.textContent;
                     if(seekingText.includes(cardId) && (cardName === "未知姓名" || seekingText.includes(cardName))) {
                        seekingCard.style.backgroundColor = '#e6ffe6';
                        let foundNotice = seekingCard.querySelector('.found-notice');
                        if (!foundNotice) {
                            foundNotice = document.createElement('p');
                            foundNotice.classList.add('found-notice');
                            foundNotice.style.color = 'var(--success-color)';
                            foundNotice.style.fontWeight = 'bold';
                            foundNotice.style.marginTop = '10px';
                            seekingCard.appendChild(foundNotice);
                        }
                        foundNotice.textContent = '[状态更新：此卡可能已被寻回，请在“已拾取信息”中核实！]';
                        const reportButton = seekingCard.querySelector('button');
                        if(reportButton) reportButton.disabled = true;
                    }
                }
            });
            
            userPoints += 10; // 模拟拾卡加分
            showGlobalMessage('拾卡信息已提交！感谢您的热心帮助，获得10点积分。信息已更新至“已拾取信息”列表。', 'success');
            updateMapMarkers();
            this.reset();
            
            const browseFoundTabButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.getAttribute('onclick').includes('tab-browse-found'));
            if(browseFoundTabButton) openTab(null, 'tab-browse-found');
        });
        
        function reportFoundForThis(studentId, studentName, location) {
            document.getElementById('found-card-id').value = studentId.includes('****') ? '' : studentId;
            document.getElementById('found-card-name').value = studentName;
            document.getElementById('found-location').value = location; // Pre-fill location
            
            const reportFoundTabButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.getAttribute('onclick').includes('tab-report-found'));
            if(reportFoundTabButton) openTab(null, 'tab-report-found');
            document.getElementById('found-location').focus();
        }

        function simulateNearSignalInteractive(cardIdSuffix) {
            const nearSignalDiv = document.getElementById(`my-near-signal-${cardIdSuffix}`);
            const signalText = document.getElementById(`my-near-signal-text-${cardIdSuffix}`);
            const signalBar = document.getElementById(`my-signal-bar-${cardIdSuffix}`);
            const farLocationSpan = document.getElementById(`my-far-location-${cardIdSuffix}`);

            if (!nearSignalDiv || !signalText || !signalBar) return;

            nearSignalDiv.style.display = 'block';
            signalText.textContent = "正在连接蓝牙设备...";
            signalBar.style.width = '10%';
            signalBar.style.backgroundColor = '#6c757d';
            signalBar.textContent = '';

            const stages = [
                { text: "信号弱，距离 > 20米", width: '30%', color: 'var(--warning-color)', label: '弱', farHint: "感应到在体育馆方向" },
                { text: "信号中，距离 < 20米", width: '60%', color: 'var(--info-color)', label: '中', farHint: "感应到在教学楼A座附近" },
                { text: "信号强！距离 < 5米，就在附近！", width: '95%', color: 'var(--success-color)', label: '强', farHint: "当前位置极近" }
            ];
            let currentStage = 0;
            function updateSignal() {
                if (currentStage < stages.length) {
                    signalText.textContent = stages[currentStage].text;
                    signalBar.style.width = stages[currentStage].width;
                    signalBar.style.backgroundColor = stages[currentStage].color;
                    signalBar.textContent = stages[currentStage].label;
                    if(farLocationSpan) farLocationSpan.textContent = stages[currentStage].farHint;
                    currentStage++;
                    setTimeout(updateSignal, 1500);
                }
            }
            updateSignal();
        }

        function markMyCardAsFound(cardUniqueId, buttonElement) {
            const myLostItemCard = document.getElementById(`my-lost-${cardUniqueId}`);
            if (!myLostItemCard) return;

            const statusSpan = myLostItemCard.querySelector('.my-status-indicator');
            const nearSignalDiv = myLostItemCard.querySelector(`#my-near-signal-${cardUniqueId}`);
            
            if (statusSpan) {
                statusSpan.textContent = '已找回 ✔';
                statusSpan.style.color = 'var(--success-color)';
                statusSpan.style.fontWeight = 'bold';
                
                if(nearSignalDiv) nearSignalDiv.style.display = 'none';
                
                const scanButton = myLostItemCard.querySelector('.btn-warning');
                if (scanButton) scanButton.disabled = true;
                if (buttonElement) buttonElement.disabled = true;
                
                const seekingItem = document.getElementById(`seeking-${cardUniqueId}`);
                if(seekingItem) {
                    const h3Content = myLostItemCard.querySelector('h3').textContent.replace('我的卡：','寻找');
                    seekingItem.innerHTML = `<h3>${h3Content}</h3><p style="color:var(--success-color); font-weight:bold; text-align:center; padding:10px; border:1px solid var(--success-color); border-radius:4px;">此卡失主已自行找回！</p>`;
                }
                showGlobalMessage(`您的校园卡 (${myLostItemCard.querySelector('h3').textContent.split('：')[1].trim()}) 已标记为“已找回”。`, 'success');
            }
        }

        function renderHistogram() {
            const histogramContainer = document.getElementById('risk-histogram');
            if (!histogramContainer || histogramContainer.dataset.rendered === 'true') { // Prevent re-rendering if already done
                // To force re-render if data changes, clear the flag or the content
                // For this demo, simple check is enough
                 if(histogramContainer.innerHTML.trim() !== "") return;
            }
            histogramContainer.innerHTML = ''; 
            const riskData = [
                { area: "图书馆", count: 35, color: "#0d6efd" },
                { area: "第一食堂", count: 28, color: "#6f42c1" },
                { area: "第二教学楼", count: 19, color: "#198754" },
                { area: "体育馆", count: 15, color: "#fd7e14" },
                { area: "校内超市", count: 13, color: "#ffc107" },
                { area: "校巴站台", count: 12, color: "#dc3545" }
            ];
            const maxCount = Math.max(...riskData.map(d => d.count), 1);

            riskData.forEach(item => {
                const barWrapper = document.createElement('div');
                barWrapper.classList.add('bar-wrapper');
                
                const barValue = document.createElement('div'); // Create value div first to append to wrapper
                barValue.classList.add('bar-value');
                barValue.textContent = item.count;
                
                const bar = document.createElement('div');
                bar.classList.add('bar');
                const barHeightPercentage = (item.count / maxCount) * 90;
                bar.style.height = `0%`; 
                bar.style.backgroundColor = item.color;
                
                const barLabel = document.createElement('div');
                barLabel.classList.add('bar-label');
                barLabel.textContent = item.area;
                
                barWrapper.appendChild(barValue);
                barWrapper.appendChild(bar); // Bar below value
                barWrapper.appendChild(barLabel); // Label below bar container
                histogramContainer.appendChild(barWrapper);

                setTimeout(() => { // Animate bar height
                    bar.style.height = `${barHeightPercentage}%`;
                }, 100);
            });
            histogramContainer.dataset.rendered = 'true'; // Mark as rendered
        }
        
        function redeemItem(itemName, pointsCost) {
            if (userPoints >= pointsCost) {
                userPoints -= pointsCost;
                document.getElementById('user-points').textContent = `${userPoints} 积分`;
                showGlobalMessage(`成功兑换 "${itemName}"！消耗 ${pointsCost} 积分。`, 'success');
            } else {
                showGlobalMessage(`兑换失败，您的积分不足以兑换 "${itemName}"。`, 'danger');
            }
        }

        function populateMyLostCardsDemo() {
            const listElement = document.getElementById('my-lost-reports-list');
            const noMyReportsMsg = document.getElementById('no-my-lost-reports');
            
            if (listElement.children.length > 0 && (listElement.children.length > 1 || (listElement.children.length === 1 && listElement.children[0].id !== 'no-my-lost-reports'))) {
                return; // Already has content or a non-placeholder item
            }

            if (noMyReportsMsg) noMyReportsMsg.style.display = 'none'; // Hide "no reports" message
            
            const demoCard = { id: 'demoCard0', studentId: '2024****111', name: '示例用户', lastSeen: '教学楼C座门口', farLocationHint: '教学楼区域', rewardPoints: 10, contact: '13912345678' };

            const myLostItemHTML = `
                <div class="item-card" id="my-lost-${demoCard.id}">
                    <h3>我的卡：${demoCard.studentId} (${demoCard.name})</h3>
                    <p><strong>最后已知地点:</strong> ${demoCard.lastSeen}</p>
                    <p><strong>悬赏积分:</strong> ${demoCard.rewardPoints} 分</p>
                    <p>状态: <span class="my-status-indicator" id="my-status-${demoCard.id}" style="color:var(--warning-color); font-weight:bold;">搜寻中...</span></p>
                    <div class="bluetooth-sim">
                        <p><strong>远距离蓝牙示意:</strong> 大致在 <span id="my-far-location-${demoCard.id}">${demoCard.farLocationHint}</span></p>
                        <button class="btn btn-sm btn-warning" onclick="simulateNearSignalInteractive('${demoCard.id}')">开始近距离感应</button>
                        <div id="my-near-signal-${demoCard.id}" style="display: none; margin-top: 10px;">
                            <p><strong>近距离信号:</strong> <span id="my-near-signal-text-${demoCard.id}">正在搜索...</span></p>
                            <div class="signal-strength"><div id="my-signal-bar-${demoCard.id}" class="signal-bar"></div></div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" style="margin-top: 10px;" onclick="markMyCardAsFound('${demoCard.id}', this)">我已找回此卡</button>
                </div>`;
            listElement.insertAdjacentHTML('afterbegin', myLostItemHTML);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Set default datetime for found card form to current time
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for local timezone
            document.getElementById('found-time').value = now.toISOString().slice(0,16);

            const initialTabButton = document.querySelector('.tab-button.active');
            if (initialTabButton) {
                 openTab(null, initialTabButton.getAttribute('onclick').match(/'([^']+)'/)[1]);
            }
        });
    </script>
</body>
</html>